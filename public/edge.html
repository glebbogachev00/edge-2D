<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>White City — 2D Flow Experience</title>
<style>
  :root{
    --bg:#FAFAFA; --shadow:#E9EDF1; --line:#2A2F35; --lineSoft:#2A2F35AA;
    --red:#E1122C; --blue:#1D74D4; --yellow:#F4B400; --green:#2AAE6E; --black:#111;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--black);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:10px 14px;user-select:none}
  header{display:flex;gap:10px;align-items:center;opacity:.7}
  header .dot{width:8px;height:8px;border-radius:50%}
  header .dot.red{background:var(--red)} header .dot.blue{background:var(--blue)} header .dot.green{background:var(--green)}
  header .legend{font-size:12px}
  #canvas{display:block;width:100%;height:100%}
  footer{display:flex;justify-content:space-between;align-items:center;font-size:12px;opacity:.6}
  .btn{border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .btn:focus{outline:2px solid var(--lineSoft);outline-offset:2px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="White City flow experience">
  <header aria-hidden="true">
    <div class="dot red" title="Invitation / route"></div>
    <div class="dot blue" title="Surveillance"></div>
    <div class="dot green" title="Relief / organic"></div>
    <div class="legend">Arrow/Touch to drift • R toggle + hold boost • Y swap red/yellow • M sound • Space pause • Click = ripple</div>
  </header>
  <canvas id="canvas" aria-label="City panorama"></canvas>
  <footer>
    <button id="toggleMotion" class="btn" aria-pressed="false">Reduce Motion: Off</button>
    <div>© White City — a minimal, non-game experience</div>
    <button id="restart" class="btn">Restart</button>
  </footer>
</div>

<div class="sr-only" aria-live="polite" id="a11y"></div>

<script>
(() => {
  // ---------- Setup ----------
  const DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let W=0, H=0;
  function resize() {
    const r = canvas.getBoundingClientRect();
    W = Math.max(640, r.width)|0;
    H = Math.max(360, r.height)|0;
    canvas.width = (W * DPR) | 0;
    canvas.height = (H * DPR) | 0;
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ---------- Preferences ----------
  let reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const a11yLive = document.getElementById('a11y');

  // ---------- Input ----------
  let input = {right:0,left:0,paused:false};
  let visionHold = 0;           // 0..1 while R is held
  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowRight') input.right=1;
    if(e.key==='ArrowLeft')  input.left=1;
    if(e.key===' ')          input.paused=!input.paused;
    if(e.key==='r'||e.key==='R'){ runnerVisionActive = !runnerVisionActive; visionHold = 1; } // toggle + hold boost
    if(e.key==='y'||e.key==='Y'){ accentYellow = !accentYellow; } // swap red/yellow
    if(e.key==='m'||e.key==='M') toggleAudio();
  });
  window.addEventListener('keyup', e=>{
    if(e.key==='ArrowRight') input.right=0;
    if(e.key==='ArrowLeft')  input.left=0;
    if(e.key==='r'||e.key==='R'){ visionHold = 0; }
  });
  // Touch: tap/hold to drift + ripple
  canvas.addEventListener('pointerdown', e=>{
    input.right=1;
    addRipple(e);
    initAudio();
  });
  window.addEventListener('pointerup',   e=>{ input.right=0; });

  // ---------- World timeline ----------
  const WORLD_LEN = 9000;
  let t=0, x=0, v=40;
  const MAX_V = 140;

  // Landmarks
  const redHints = [
    {x:  600, yRatio:.62, w:120, h:12},
    {x: 1150, yRatio:.55, w:100, h:10},
    {x: 1700, yRatio:.58, w:160, h:12},
    {x: 2400, yRatio:.52, w: 90, h:10},
    {x: 3200, yRatio:.50, w:180, h:12},
    {x: 4100, yRatio:.47, w:120, h:10},
    {x: 5200, yRatio:.45, w:200, h:12},
    {x: 6400, yRatio:.48, w:160, h:10},
    {x: 7600, yRatio:.46, w:140, h:10},
  ];
  const blueScans = [
    {x: 2000, w:260, period:4.0},
    {x: 3600, w:320, period:3.2},
    {x: 5200, w:380, period:2.6},
    {x: 7000, w:420, period:2.2},
  ];
  const garden = {x: 8000, w: 650};

  // ---------- Runner’s Vision ----------
  let runnerVisionActive = true;
  let accentYellow = false; // false = red, true = yellow

  // ---------- Parallax city layers ----------
  function makeLayer(seed, density, baseY, jitterY, color, alpha){
    const rng = mulberry32(seed);
    const items=[];
    for(let i=0;i<density;i++){
      const ix = rng()*WORLD_LEN;
      const w = 60 + rng()*220;
      const h = 80 + rng()*360;
      const y = H*baseY + (rng()*2-1)*jitterY*H;
      items.push({x:ix,w,h,y});
    }
    return {items,color,alpha};
  }
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  let layers=[];
  function regenLayers(){
    layers = [
      makeLayer(1, 26, 0.72, 0.03, getVar('--shadow'), 1.0),
      makeLayer(2, 18, 0.66, 0.02, '#F2F4F6', 1.0),
      makeLayer(3, 14, 0.78, 0.02, '#ECEFF3', 1.0),
    ];
  }
  regenLayers();

  // ---------- Audio ----------
  let audioEnabled=false;
  let ac, windNode, humNode, masterGain;
  function initAudio(){
    if(audioEnabled || reduceMotion) return;
    ac = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = ac.createGain(); masterGain.gain.value=0.18; masterGain.connect(ac.destination);

    // Wind: filtered noise
    const noiseBuf = ac.createBuffer(1, ac.sampleRate*2, ac.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*0.35;
    const noise = ac.createBufferSource(); noise.buffer=noiseBuf; noise.loop=true;
    const windFilter = ac.createBiquadFilter(); windFilter.type='lowpass'; windFilter.frequency.value=500;
    windNode = ac.createGain(); windNode.gain.value=0.4;
    noise.connect(windFilter).connect(windNode).connect(masterGain);
    noise.start();

    // Hum
    humNode = ac.createOscillator(); humNode.type='sine'; humNode.frequency.value=46;
    const humGain = ac.createGain(); humGain.gain.value=0.08;
    humNode.connect(humGain).connect(masterGain);
    humNode.start();
    audioEnabled=true;
  }
  function setAudioMovementFactor(f){
    if(!audioEnabled) return;
    masterGain.gain.setTargetAtTime(0.12 + 0.12*f, ac.currentTime, 0.2);
    windNode.gain.setTargetAtTime(0.25 + 0.35*f, ac.currentTime, 0.2);
  }
  function toggleAudio(){
    if(!audioEnabled){ initAudio(); a11yLive.textContent='Sound on'; }
    else { ac.suspend(); audioEnabled=false; a11yLive.textContent='Sound off'; }
  }

  // ---------- Utilities ----------
  function getVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()||'#000'}
  function lerp(a,b,t){return a+(b-a)*t}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  function easeInOutSine(t){return -(Math.cos(Math.PI*t)-1)/2}

  // ---------- Ripples ----------
  const ripples = []; // {x,y,t}
  function addRipple(e){
    const rect = canvas.getBoundingClientRect();
    const px = (e.clientX - rect.left), py = (e.clientY - rect.top);
    ripples.push({x:px, y:py, t:0});
  }
  function drawRipples(dt){
    for(let i=ripples.length-1;i>=0;i--){
      const R = ripples[i]; R.t += dt;
      const life = 1.2;
      const k = R.t / life;
      if(k>=1){ ripples.splice(i,1); continue; }
      const rad = 20 + 220*k;
      ctx.globalAlpha = 0.25*(1-k);
      ctx.strokeStyle = 'rgba(17,17,17,0.35)';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(R.x, R.y, rad, 0, Math.PI*2); ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }

  // ---------- Drawing ----------
  function drawBackgroundSky(){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#FFFFFF');
    g.addColorStop(1,'#F6F8FB');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);
  }
  function drawLayer(layer, parallax){
    ctx.fillStyle = layer.color;
    ctx.globalAlpha = layer.alpha;
    for(const b of layer.items){
      const sx = (b.x - x*parallax);
      if(sx+b.w < -200 || sx > W+200) continue;
      ctx.fillRect(sx, b.y - b.h, b.w, b.h);
      if (b.h>200 && Math.random()<0.002){
        ctx.fillRect(sx, b.y - b.h*0.6, b.w, 1);
      }
    }
    ctx.globalAlpha = 1;
  }
  function drawHorizonLines(){
    ctx.strokeStyle = '#EFF2F6';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0;i<3;i++){
      const y = H*(0.55 + i*0.08);
      ctx.moveTo(0,y); ctx.lineTo(W,y);
    }
    ctx.stroke();
  }
  function drawRedHints(){
    for(const r of redHints){
      const y = H*r.yRatio;
      const sx = r.x - x*1.0;
      if(sx+r.w < -50 || sx > W+50) continue;

      const dist = Math.abs(sx + r.w*0.5 - W*0.45);
      const near = clamp(1 - dist/320, 0, 1);
      const pulse = runnerVisionActive ? (0.5 + 0.5*Math.sin(t*3.5)) : 0.15;

      const [cr,cg,cb] = accentYellow ? [244,180,0] : [225,18,44];
      const holdBoost = visionHold ? 0.30 : 0.0; // only affects bar brightness
      const a = 0.10 + 0.60*near + 0.20*pulse*near + holdBoost*near;

      ctx.fillStyle = `rgba(${cr},${cg},${cb},${a.toFixed(3)})`;
      ctx.fillRect(sx, y, r.w, r.h);
      ctx.fillStyle = `rgba(${cr},${cg},${cb},${(a*0.6).toFixed(3)})`;
      ctx.fillRect(sx, y-2, r.w, 1);
    }
    // (Removed global tint overlay to avoid red background)
  }
  function drawBlueScans(){
    for(const s of blueScans){
      const sx = s.x - x*1.0;
      if(sx+s.w < -50 || sx > W+50) continue;
      const phase = (t % s.period) / s.period;
      const a = 0.12 + 0.25*easeInOutSine(phase);
      ctx.fillStyle = `rgba(29,116,212,${a.toFixed(3)})`;
      ctx.fillRect(sx, H*0.50, s.w, H*0.5);
      ctx.globalAlpha = 0.35 + 0.35*easeInOutSine(phase);
      ctx.fillStyle = '#1D74D4';
      const scanY = lerp(H*0.50, H*0.95, phase);
      ctx.fillRect(sx, scanY, s.w, 2);
      ctx.globalAlpha = 1;
    }
  }
  function drawGarden(){
    const gx = garden.x - x*1.0;
    if(gx > W+200) return;
    const w = garden.w;
    ctx.fillStyle = 'rgba(42,174,110,0.18)';
    ctx.fillRect(gx, H*0.58, w, H*0.42);
    for(let i=0;i<12;i++){
      const px = gx + i*(w/12) + Math.sin((i*37)%6)*6;
      const ph = 10 + (i%3)*8;
      ctx.fillStyle = 'rgba(42,174,110,0.35)';
      ctx.beginPath();
      ctx.ellipse(px, H*0.80, 26, ph, 0, 0, Math.PI*2);
      ctx.fill();
    }
  }
  function drawForegroundRail(){
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, H*0.92, W, H*0.08);
    ctx.fillStyle = '#EDEFF3';
    for(let i=0;i<W;i+=60){
      ctx.fillRect(i, H*0.92, 20, 2);
    }
  }
  function drawVignetteFade(progress){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,`rgba(255,255,255,${0.0+0.6*progress})`);
    g.addColorStop(1,`rgba(255,255,255,${0.2+0.8*progress})`);
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }

  // ---------- Loop ----------
  let last=performance.now();
  function frame(now){
    const dt = clamp((now - last)/1000, 0, 0.05);
    last = now;
    if(!input.paused){
      t += dt;
      const userAccel = (input.right?1:0) - (input.left?0.6:0);
      const targetV = reduceMotion ? 28 : lerp(40, MAX_V, clamp(userAccel*0.9, 0, 1));
      v = lerp(v, targetV, 0.6*dt);
      x += v * dt;
      x = Math.min(x, WORLD_LEN);
      setAudioMovementFactor(clamp((v-40)/(MAX_V-40), 0, 1));
    }
    render(dt);
    requestAnimationFrame(frame);
  }

  function render(dt){
    drawBackgroundSky();
    drawLayer(layers[1], 0.35);
    drawLayer(layers[0], 0.55);
    drawLayer(layers[2], 0.75);
    drawHorizonLines();
    drawBlueScans();
    drawRedHints();
    drawGarden();
    drawForegroundRail();
    drawRipples(dt);

    const endStart = WORLD_LEN - 600;
    const fade = x > endStart ? clamp((x - endStart)/800, 0, 1) : 0;
    if(fade>0) drawVignetteFade(fade);
  }

  // ---------- Controls UI ----------
  const btnMotion = document.getElementById('toggleMotion');
  btnMotion.addEventListener('click', ()=>{
    reduceMotion=!reduceMotion;
    btnMotion.textContent = `Reduce Motion: ${reduceMotion?'On':'Off'}`;
    btnMotion.setAttribute('aria-pressed', reduceMotion?'true':'false');
    a11yLive.textContent = reduceMotion?'Reduced motion enabled':'Reduced motion disabled';
  });
  document.getElementById('restart').addEventListener('click', ()=>{
    x=0; t=0; v=40; regenLayers(); ripples.length=0;
    a11yLive.textContent='Restarted';
  });

  // Kickoff
  render(0);
  requestAnimationFrame(frame);

  // Start audio on first interaction per browser policies
  window.addEventListener('pointerdown', ()=>{ initAudio(); }, {once:true});
})();
</script>
</body>
</html>
